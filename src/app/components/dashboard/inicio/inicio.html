<div class="dashboard-container">
    <!-- Loading State -->
    <div *ngIf="loading" class="loading-container">
        <div class="spinner"></div>
        <p>Cargando datos...</p>
    </div>

    <!-- Error State -->
    <div *ngIf="error && !loading" class="error-container">
        <p>{{ error }}</p>
    </div>

    <!-- Dashboard Content -->
    <div *ngIf="!loading && !error" class="dashboard-content">

        <!-- Header -->
        <div class="dashboard-header">
            <h1>Dashboard de Compras</h1>
            <p>An√°lisis de transacciones y gastos</p>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-blue">
                <div class="stat-content">
                    <div class="stat-info">
                        <p class="stat-label">Total Gastado</p>
                        <p class="stat-value">${{ totalAmount.toLocaleString('en-US', {minimumFractionDigits: 2,
                            maximumFractionDigits: 2}) }}</p>
                    </div>
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="1" x2="12" y2="23"></line>
                            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card stat-green">
                <div class="stat-content">
                    <div class="stat-info">
                        <p class="stat-label">Transacciones</p>
                        <p class="stat-value">{{ totalTransactions }}</p>
                    </div>
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <circle cx="9" cy="21" r="1"></circle>
                            <circle cx="20" cy="21" r="1"></circle>
                            <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card stat-purple">
                <div class="stat-content">
                    <div class="stat-info">
                        <p class="stat-label">Promedio</p>
                        <p class="stat-value">${{ averageAmount.toLocaleString('en-US', {minimumFractionDigits: 2,
                            maximumFractionDigits: 2}) }}</p>
                    </div>
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                        </svg>
                    </div>
                </div>
            </div>

            <div class="stat-card stat-orange">
                <div class="stat-content">
                    <div class="stat-info">
                        <p class="stat-label">Mediana</p>
                        <p class="stat-value">${{ medianAmount.toLocaleString('en-US', {minimumFractionDigits: 2,
                            maximumFractionDigits: 2}) }}</p>
                    </div>
                    <div class="stat-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Insights Section -->
        <div class="insights-section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M9 18l6-6-6-6" />
                </svg>
                Insights Inteligentes
            </h2>
            <div class="insights-grid">
                <div *ngFor="let insight of insights" class="insight-card" [ngClass]="'insight-' + insight.type">
                    <div class="insight-icon">{{ insight.icon }}</div>
                    <div class="insight-content">
                        <h3 class="insight-title">{{ insight.title }}</h3>
                        <p class="insight-description">{{ insight.description }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Grid -->
        <div class="charts-grid">

            <!-- Bar Chart -->
            <div class="chart-card">
                <h2 class="chart-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                    Gastos por Comercio
                </h2>
                <div class="chart-container">
                    <canvas baseChart [type]="barChartType" [data]="barChartData" [options]="barChartOptions">
                    </canvas>
                </div>
            </div>

            <!-- Pie Chart -->
            <div class="chart-card">
                <h2 class="chart-title">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2">
                        <path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path>
                        <path d="M22 12A10 10 0 0 0 12 2v10z"></path>
                    </svg>
                    Distribuci√≥n de Gastos
                </h2>
                <div class="chart-container">
                    <canvas baseChart [type]="pieChartType" [data]="pieChartData" [options]="pieChartOptions">
                    </canvas>
                </div>
            </div>

        </div>

        <!-- Timeline Chart - Full Width -->
        <div class="chart-card chart-full">
            <h2 class="chart-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    <line x1="16" y1="2" x2="16" y2="6"></line>
                    <line x1="8" y1="2" x2="8" y2="6"></line>
                    <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
                Timeline de Compras
            </h2>
            <div class="chart-container-large">
                <canvas baseChart [type]="lineChartType" [data]="lineChartData" [options]="lineChartOptions">
                </canvas>
            </div>
        </div>

        <!-- Transactions Table -->
        <!-- Transactions Table -->
        <div class="table-section">
            <h2 class="section-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2">
                    <path d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                Historial de Transacciones
            </h2>

            <!-- üîπ Filtro de mes -->
            <div class="filter-bar">
                <label for="monthFilter">Filtrar por mes:</label>
                <select id="monthFilter"
                    (change)="selectedMonth = ($any($event.target)?.value ?? ''); applyMonthFilter()">
                    <option value="">Todos</option>
                    <option *ngFor="let m of months" [value]="m.value">{{ m.label }}</option>
                </select>
            </div>

            <div class="table-container">
                <table class="transactions-table">
                    <thead>
                        <tr>
                            <th>Fecha</th>
                            <th>Comercio</th>
                            <th>Descripci√≥n</th>
                            <th>Medio</th>
                            <th class="text-right">Monto</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let purchase of paginatedPurchases">
                            <td>{{ formatDate(purchase.purchase_date) }}</td>
                            <td class="merchant-name">{{ getMerchantName(purchase.merchant_id) }}</td>
                            <td class="description">{{ purchase.description }}</td>
                            <td>
                                <span class="badge badge-{{ purchase.medium }}">
                                    {{ purchase.medium }}
                                </span>
                            </td>
                            <td class="text-right amount">
                                ${{ purchase.amount.toLocaleString('en-US', {minimumFractionDigits: 2,
                                maximumFractionDigits: 2}) }}
                            </td>
                            <td>
                                <span class="status-badge"
                                    [ngClass]="purchase.status === 'cancelled' ? 'status-cancelled' : 'status-completed'">
                                    {{ purchase.status }}
                                </span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- üîπ Paginaci√≥n -->
            <div class="pagination-container">
                <button (click)="previousPage()" [disabled]="currentPage === 1">
                    ‚Üê Anterior
                </button>

                <!-- Selector de items por p√°gina -->
                <select [value]="itemsPerPage" (change)="changeItemsPerPage(+($any($event.target).value))">
                    <option [value]="5">5 por p√°gina</option>
                    <option [value]="10">10 por p√°gina</option>
                    <option [value]="25">25 por p√°gina</option>
                    <option [value]="50">50 por p√°gina</option>
                </select>

                <span>P√°gina {{ currentPage }} de {{ totalPages }}</span>
                <span class="text-muted">({{ filteredPurchases.length }} registros)</span>

                <button (click)="nextPage()" [disabled]="currentPage === totalPages">
                    Siguiente ‚Üí
                </button>
            </div>
        </div>


    </div>
</div>